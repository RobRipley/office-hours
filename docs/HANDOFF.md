# Office Hours Scheduling App - Developer Handoff Document

## Quick Start for Future Claude Sessions
This document provides essential context to minimize research time when working on this project.

---

## ðŸš€ Local Development Setup

### Prerequisites
- Node.js 18+
- dfx (DFINITY SDK) - `sh -ci "$(curl -fsSL https://internetcomputer.org/install.sh)"`
- mops (Motoko package manager) - `npm i -g ic-mops`

### First Time Setup
```bash
# 1. Install Motoko dependencies
cd /Users/robertripley/coding/office-hours
mops install

# 2. Install frontend dependencies
cd frontend
npm install

# 3. Start local ICP replica (in separate terminal)
dfx start --clean --background

# 4. Deploy canisters locally
dfx deploy

# 5. Generate TypeScript bindings
dfx generate backend

# 6. Start frontend dev server
npm run dev
```

### After Initial Setup
```bash
# Terminal 1: Start replica
dfx start --background

# Terminal 2: Deploy & run frontend
dfx deploy
cd frontend && npm run dev
```

### Key URLs (Local)
- Frontend: http://localhost:3000
- Backend canister: http://127.0.0.1:4943 (proxied via Vite)
- Internet Identity: http://rdmx6-jaaaa-aaaaa-aaadq-cai.localhost:4943

### Environment Variables
The `.env` file is auto-generated by dfx with canister IDs. Key vars:
- `CANISTER_ID_BACKEND` - Backend canister ID
- `DFX_NETWORK` - `local` or `ic`

---

## Project Overview
A team scheduling app for remote office hours, hosted on **Internet Computer Protocol (ICP)**. Features:
- Google Calendar-style month-view interface
- Internet Identity authentication
- Passphrase-based access control (first user with correct token becomes admin)
- Shift creation with recurring patterns (weekly/biweekly/monthly)
- Claim queue for unclaimed shifts (6-week window)
- Time zone support across all views
- Admin panel with shift statistics

---

## Tech Stack

### Backend (Motoko)
- **Location**: `/backend/main.mo`
- **Package Manager**: mops (see `mops.toml`)
- **Dependencies**: `mo:core`, `mo:prim`
- **Auth**: Custom access control via `MixinAuthorization` mixin

### Frontend (React 18 + TypeScript)
- **Location**: `/frontend/`
- **Build Tool**: Vite
- **UI**: Tailwind CSS + shadcn/ui (Radix primitives) + Lucide icons
- **State**: TanStack Query (React Query)
- **ICP**: `@dfinity/agent`, `@dfinity/auth-client`

---

## Project Structure

```
office-hours/
â”œâ”€â”€ backend/
â”‚   â”œâ”€â”€ main.mo                    # Main actor - all canister logic
â”‚   â””â”€â”€ authorization/
â”‚       â”œâ”€â”€ access-control.mo      # Role-based access (admin/user/guest)
â”‚       â””â”€â”€ MixinAuthorization.mo  # Mixin for auth endpoints
â”œâ”€â”€ frontend/
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ App.tsx                # Root component with auth flow
â”‚   â”‚   â”œâ”€â”€ main.tsx               # Entry point with providers
â”‚   â”‚   â”œâ”€â”€ backend.ts             # TypeScript types for backend
â”‚   â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”‚   â”œâ”€â”€ ui/                # shadcn/ui components
â”‚   â”‚   â”‚   â”œâ”€â”€ AdminPanel.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ CalendarView.tsx   # Main calendar (authenticated)
â”‚   â”‚   â”‚   â”œâ”€â”€ ClaimQueue.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ CreateShiftDialog.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ EditShiftDialog.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ PublicCalendar.tsx # Read-only public view
â”‚   â”‚   â”‚   â””â”€â”€ ...
â”‚   â”‚   â”œâ”€â”€ hooks/
â”‚   â”‚   â”‚   â”œâ”€â”€ useActor.ts        # Creates ICP actor with identity
â”‚   â”‚   â”‚   â”œâ”€â”€ useInternetIdentity.tsx  # Auth context/hook
â”‚   â”‚   â”‚   â””â”€â”€ useQueries.ts      # All TanStack Query hooks
â”‚   â”‚   â””â”€â”€ lib/
â”‚   â”‚       â”œâ”€â”€ timeZones.ts       # Time zone utilities
â”‚   â”‚       â””â”€â”€ utils.ts           # cn() helper for Tailwind
â”‚   â”œâ”€â”€ package.json
â”‚   â”œâ”€â”€ vite.config.ts
â”‚   â”œâ”€â”€ tailwind.config.js
â”‚   â””â”€â”€ tsconfig.json
â”œâ”€â”€ src/declarations/backend/      # dfx-generated (or stub) Candid bindings
â”‚   â”œâ”€â”€ backend.did.js
â”‚   â””â”€â”€ backend.did.d.ts
â”œâ”€â”€ dfx.json                       # ICP canister config
â”œâ”€â”€ mops.toml                      # Motoko dependencies
â””â”€â”€ spec.md                        # Full requirements
```

---

## Key Data Types

### Motoko (backend/main.mo)
```motoko
type Shift = {
  id : Nat;
  startTime : Time.Time;      // Nanoseconds since epoch
  endTime : Time.Time;
  recurrence : ?Recurrence;   // #weekly | #biweekly | #monthly
  notes : Text;
  meetingLink : Text;
  hostName : Text;            // Empty = unclaimed
};

type UserProfile = {
  principal : Principal;
  name : Text;
  homeTimeZone : TimeZone;
};

type UserRole = { #admin; #user; #guest };
```

### TypeScript (frontend/src/backend.ts)
```typescript
interface Shift {
  id: bigint;
  startTime: bigint;
  endTime: bigint;
  recurrence: 'weekly' | 'biweekly' | 'monthly' | null;
  notes: string;
  meetingLink: string;
  hostName: string;
}
```

---

## Backend API

### Public
- `getPublicShifts()` - Claimed shifts only

### Authenticated Users
- `getCallerUserProfile()` / `saveCallerUserProfile(profile)`
- `getShifts()` - All shifts
- `getClaimQueue()` - Unclaimed in next 6 weeks
- `createShift(startTime, endTime, recurrence, notes, meetingLink)`
- `editShift(shiftId, startTime, endTime, notes, meetingLink, hostName)`
- `deleteShift(shiftId)`
- `claimShift(shiftId, hostName)`

### Admin Only
- `getAdminSummary()` - Stats + per-user breakdown
- `isCallerAdmin()`
- `assignCallerUserRole(user, role)`

### Auth
- `_initializeAccessControlWithSecret(userSecret)` - First correct token = admin
- `getCallerUserRole()`

---

## Frontend Query Hooks

All in `/frontend/src/hooks/useQueries.ts`:

```typescript
// Profile
useGetCallerUserProfile()
useSaveCallerUserProfile()

// Shifts
useGetShifts()           // Authenticated - all shifts
useGetPublicShifts()     // Public - claimed only
useGetClaimQueue()       // Unclaimed (6 weeks)

// Mutations
useCreateShift()
useEditShift()
useDeleteShift()
useClaimShift()

// Admin
useIsCallerAdmin()
useGetAdminSummary()
```

---

## Critical: Time Handling

**ICP Time.Time = nanoseconds** (1 second = 1,000,000,000 ns)

```typescript
// Timestamp â†’ Date
const date = new Date(Number(timestamp) / 1_000_000);

// Date â†’ Timestamp
const timestamp = BigInt(date.getTime() * 1_000_000);
```

---

## Authentication Flow

1. User clicks login â†’ Internet Identity popup
2. `useInternetIdentity` hook provides identity
3. Check for profile via `getCallerUserProfile`
4. **No profile** â†’ `ProfileSetupModal` (name + timezone)
5. **Profile but guest** â†’ `PassphraseModal`
6. User enters passphrase â†’ `_initializeAccessControlWithSecret`
7. Role assigned â†’ `AuthenticatedView`

---

## Common Tasks

### Adding a Backend Method
1. Add function in `backend/main.mo`
2. Run `dfx generate backend`
3. Add hook in `useQueries.ts`
4. Use in component

### Modifying UI Components
Components use shadcn/ui patterns. All UI primitives are in `/frontend/src/components/ui/`.

---

## Gotchas

1. **BigInt everywhere** - All ICP numbers are BigInt in TypeScript
2. **Time = nanoseconds** - Divide by 1,000,000 for JS milliseconds
3. **Candid optionals** - `?Type` becomes `[] | [Type]` in generated code
4. **Recurring shifts** - Same ID, different start/end times per instance
5. **dfx generate** - Run after ANY backend change to update types

---

## Files to Read First

1. `spec.md` - Requirements
2. `backend/main.mo` - All canister logic
3. `frontend/src/hooks/useQueries.ts` - API integration
4. Relevant component in `/frontend/src/components/`

---

*Last updated: Local deployment setup complete*
